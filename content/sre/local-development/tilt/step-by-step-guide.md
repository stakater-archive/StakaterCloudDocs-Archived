# Step by Step Guide

1) Following tools are required

- Tilt v0.22.11 or above
- Docker 20.10.8 or above
- Helm 3
- oc binaries

2) Enable sandbox namespace/project/environment for your tenant; you can read more [here](https://docs.cloud.stakater.com/content/sre/tenant-operator/customresources.html#_1-tenant)

3) Login to cluster

```bash
oc login --token=<TOKEN> --server=<SERVER>
```

4) Switch project to sandbox namespace/project/environment

```bash
oc project <MY-SANDBOX>
```

5) Login to docker registry

**MacOS**

```bash
HOST=$(oc get route image-registry -n openshift-image-registry --template='{{ .spec.host }}')
docker login -u $(oc whoami) -p $(oc whoami -t) $HOST
```

NOTE: If oc command fails then ask SCA (SAAP Cluster Admin) to provide you the route

6) Add helm chart repos (Optional)

If you reference helm charts from private registry then you first need to add it

```bash
cd deploy;

# helm credentials can be found in vault or in a secret in build namespace
helm repo add stakater-nexus <private repo url> --username helm-user-name --password ********; 
```

7) Update helm dependencies

```bash
helm dependency update

cd ..
```

8) Add Tiltfile to your application 

[Here](./tiltfile-content.md) is a sample Tiltfile for a Java based project with a specific [Dockerfile](./dockerfile-content.md).

9) Update `local_resource` in the Tiltfile

Make sure the app jar file name under `local_resource` matches with the jar name generated by your application in target folder
 
10) Add `tilt_options.json` file to your application

Should be created locally by everyone in base directory and it should have following content as per the user. User email in `allow_k8s_contexts` should be same email that is used as tenant member email. Run $(oc whoami -c) to get the current context.

```json
{
    "namespace": "tilt-username-sandbox",
    "default_registry": "image-registry-openshift-image-registry.apps.[CLUSTER-NAME].[CLUSTER-ID].kubeapp.cloud/{}",
    "allow_k8s_contexts": "tilt-username-sandbox/api-[CLUSTER-NAME]-[CLUSTER-ID]-kubeapp-cloud:6443/user@email.com"
}
```

NOTE: Remember `tilt_options.json` should be git ignored

11) Update `.gitigore`

```
# Tilt
tilt_options.json
tilt_modules/

# Helm
/deploy/charts
```

12) Add `.tiltignore` with the following content

```
**/charts
**/tmpcharts
```

13) Add `values-local.yaml` in a `tilt` folder in base application directory. 

`values-local.yaml` should contain the following content. Make sure that replica count should always be 1.

```yaml
application:

  space:
    enabled: false
  
  namespace:
    enabled: false

  deployment:
    imagePullSecrets: null

    # Tilt live update only supports one replica
    replicas: 1
```

14) Run `tilt up` at base directory 

Press space key to view the progress in Tilt web UI. The application should be running in the namespace used in `tilt_options.json` file.

15) Run `tilt down` to delete the application and related configuration from the namespace
