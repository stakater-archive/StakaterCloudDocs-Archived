## Introduction
Modern micro-services consists of a lot of dependencies and usually involves a lot of steps from development to deployment and testing. Tilt automates all this by watching the code changes, building docker images, deploying the code and bringing everything in sync.

## Installation
Tilt can be installed by following the instructions [here](https://docs.tilt.dev/index.html#install-tilt).

## Step by Step Guide

Tilt can be used just by running the command `tilt up` which will compile the code, build the docker image and deploys it on cluster.

1. Login to cluster

```bash
oc login --token=<TOKEN> --server=<SERVER>
```

2. Switch project

```bash
oc project <MY-SANDBOX>
```

3. Login to docker registry

**MacOS**

```bash
HOST=$(oc get route default-route -n openshift-image-registry --template='{{ .spec.host }}')
docker login -u username -p $(oc whoami -t) $HOST
```

**Windows**

```bash
SET HOST=$(oc get route default-route -n openshift-image-registry --template='{{ .spec.host }}')
docker login -u username -p $(oc whoami -t) $HOST
```

4. Add helm chart repos (Optional)

If you reference helm charts from private registry then you first need to add it

```bash
cd deploy;

# helm credentials can be found in vault or in a secret in build namespace
helm repo add stakater-nexus <private repo url> --username helm-user-name --password ********; 
```

5. Update helm dependencies

```bash
helm dependency update

cd ..
```

6. Add Tiltfile to your application 

[Here](Tiltfile) is a sample Tiltfile for a Java based project with a specific Dockerfile.

8. Update `local_resource` in the Tiltfile

Make sure the app jar file name under `local_resource` matches with the jar name generated by your application in target folder
 
9. Add `tilt_options.json` file 

Should be created locally by everyone in base directory and it should have following content as per the user

```json
{
    "namespace": "tilt-username-sandbox",
    "default_registry": "image-registry-openshift-image-registry.apps.[CLUSTER-NAME].[CLUSTER-ID].kubeapp.cloud/{}",
    "allow_k8s_contexts": "tilt-username-sandbox/api-[CLUSTER-NAME]-[CLUSTER-ID]-kubeapp-cloud:6443/user@email.com"
}
```

10. Add .tiltignore with the following content

```
**/charts
**/tmpcharts
```

11. Add `values-local.yaml` in a `tilt` folder in base application directory. 

`values-local.yaml` should contain the following content. Make sure that replica count should always be 1.

```yaml
application:

  space:
    enabled: false
  
  namespace:
    enabled: false

  deployment:
    imagePullSecrets: null

    # Tilt live update only supports one replica
    replicas: 1
```

12. Run `tilt up` at base directory 

Press space key to view the progress in web browser. The application should be running in the namespace used in `tilt_options.json` file.

13. Run `tilt down` to delete the application and related configuration from the namespace
