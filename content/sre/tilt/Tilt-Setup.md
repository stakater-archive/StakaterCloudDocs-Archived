## Introduction
Modern micro-services consists of a lot of dependencies and usually involves a lot of steps from development to deployment and testing. Tilt automates all this by watching the code changes, building docker images, deploying the code and bringing everything in sync.

## Installation
Tilt can be installed by following the instructions [here](https://docs.tilt.dev/index.html#install-tilt).

## Setup
Tilt can be used just by running the command `tilt up` which will compile the code, build the docker image and deploys it on cluster.

### Prerequisites
1. Login to cluster and then change project to your own sandbox project.

```bash
oc login --token=<TOKEN> --server=<SERVER>
```

2. Docker should be running. Login to Docker

```bash
HOST=$(oc get route default-route -n openshift-image-registry --template='{{ .spec.host }}')
docker login -u username -p $(oc whoami -t) $HOST
```

3. Add helm chart repos

```bash
cd deploy;
helm repo add stakater-nexus <private repo url> --username helm-user-name --password ********; # helm credentials can be taken from vault or secret in build namespace
helm dependency update
```

### Steps:

1. Add a tilt file in your code. [Here](Tiltfile) is a sample file.
2. Make sure the app jar file name under `local_resource` matches with the jar name generated by your application in target folder
3. `tilt_options.json` file should be created locally by everyone in base directory and it should have following content as per the user

```json
{
    "namespace": "tilt-username-sandbox",
    "default_registry": "image-registry-openshift-image-registry.apps.devtest.41b996e9.kubeapp.cloud/{}",
    "allow_k8s_contexts": "tilt-username-sandbox/api-devtest-41b996e9-kubeapp-cloud:6443/useremail"
}
```

4. Add tiltignore with the following content

```
**/charts
**/tmpcharts
```

5. Add `values-local.yaml` in a `tilt` folder in base application directory. values-local.yaml should contain the following content. Make sure that replica count should always be 1.

```yaml
application:

  space:
    enabled: false
  
  namespace:
    enabled: false

  deployment:
    imagePullSecrets: null

    # Tilt live update only supports one replica
    replicas: 1
```

6. Run `tilt up` at base directory and press space key to view the progress in web browser. The application should be running in the namespace used in `tilt_options.json` file.
7. Run `tilt down` to delete the application and related configuration from the namespace